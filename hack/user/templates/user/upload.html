<!DOCTYPE html>
<html>
<head>
	<title>Record Video</title>
	<script>
		const MAX_VIDEO_DURATION = 60 * 1000;
		let mediaRecorder, videoChunks, video, startTime, pausedTime;
		window.onload = function() {
			video = document.querySelector('video');
			video.currentTime = 0; // Set the time to 0
			startRecording();
		}
		function startRecording() {
    navigator.mediaDevices.getUserMedia({video: true, audio: true})
        .then(function(stream) {
            mediaRecorder = new MediaRecorder(stream);
            videoChunks = [];
            video.srcObject = stream;
            video.play();
            mediaRecorder.start();
            mediaRecorder.ondataavailable = function(e) {
                videoChunks.push(e.data);
            }
            mediaRecorder.onstop = function() {
                let blob = new Blob(videoChunks, { 'type' : 'video/mp4' });
                let url = URL.createObjectURL(blob);
                video.src = url;
                let formData = new FormData();
                formData.append('video_file', blob, 'video.mp4');
                sendVideo(formData);
            }
            let paused = false;
            let pauseTime = 0;
            video.addEventListener('pause', function() {
                paused = true;
                pauseTime = video.currentTime;
                mediaRecorder.pause();
            });
            video.addEventListener('play', function() {
                if (paused) {
                    startTime = pauseTime;//Date.now() - (pauseTime * 1000);
                    paused = false;
                    mediaRecorder.resume();
                } else {
                    startTime = Date.now();
                }
            });
            setInterval(function() {
                let elapsedTime = Date.now() - startTime;
                let currentTime = paused ? pauseTime : elapsedTime / 1000;
                video.currentTime = currentTime;
            }, 100);
            setTimeout(function() {
                stopRecording();
            }, MAX_VIDEO_DURATION);
        })
        .catch(function(err) {
            console.log('Error: ' + err.message);
        });
}
		function stopRecording() {
			mediaRecorder.stop();
			video.pause();
			video.currentTime = 0;
		}
		function sendVideo(formData) {
    let xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload_video/');
    xhr.send(formData);
    xhr.onload = function() {
        if (xhr.status == 200) {
            window.location.reload();
        }
    }
}
	</script>
</head>
<body>
	<h1>Record Video</h1>
	<p>Record a video up to one minute in length:</p>
	<video controls></video>
	<br>
	<button onclick="stopRecording()">Stop Recording and Upload</button>
</body>
</html>